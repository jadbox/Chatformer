function msgToApp(a){a=APP_TOKEN+a;if(0!=activeIFrames.length)for(i in activeIFrames){var b=activeIFrames[i].get(0).contentWindow,c=activeIFrames[i].attr("src");$.postMessage(a,get_domain(c),b)}}var numApps=0,activeIFrames=[];function addApp(a){numApps++;var b="app"+numApps,b='<iframe " src="'+(a+"#"+encodeURIComponent(document.location.href))+'" scrolling="no" id="'+b+'" frameborder="0">Loading...</iframe>',b=$(b).appendTo("#inner-applayout");activeIFrames.push(b);addAppListener(a,b)}
function addAppListener(a,b){function c(a){$("#chatinput").val(""+a);$("#chatinput").focus()}a=get_domain(a);$.receiveMessage(handleCommandListener(function(a){c(APP_TOKEN+a)},function(a){handleCoreCommand(a,b)},c),get_domain(a))}function get_domain(a){return a.replace(/([^:]+:\/\/[^\/]+).*/,"$1")};$(function(){$("#profile").click(function(){auth_logout();return!1})});function auth_logout(){$.post("/api/logout/"+getName(),{auth_token:getAuthToken()},function(a){"success"!==a.status&&alert("ERROR with status");$.removeCookie("auth_token",{path:"/"});window.location.reload()},"json")}function auth_onLogin(a,b){$.cookie("auth_token",b,{expires:1,path:"/"});$.cookie("name",a,{expires:1,path:"/"});window.location.reload()}function isAuth(){var a=getAuthToken()||"";return a&&0<a.length}
function getName(){return $.cookie("name")}function getAuthToken(){return $.cookie("auth_token")}function temp(){delayed_convo(["hello there","so welcome!"])};var h=!0;function j(a){a=APP_TOKEN+a;if(0!=k.length)for(i in k){var b=k[i].get(0).contentWindow,c=k[i].f("src");$.postMessage(a,c.replace(/([^:]+:\/\/[^\/]+).*/,"$1"),b)}}var k=[];$(function(){$("#profile").click(function(){$.i("/api/logout/"+$.cookie("name"),{auth_token:$.cookie("auth_token")},function(a){"success"!==a.status&&alert("ERROR with status");$.k("auth_token",{path:"/"});window.location.reload()},"json");return!1})});
$(function(){$("#reset").click(function(){$("#chatlog").c("")});$("#chatform").submit(function(){var a=$("#chatinput").e(),a=a.replace(/<(?:.|\n)*?>/gm,"");if(isSysMsg(a)==h)return!1;isAppMsg(a)==h&&l("<i>sent to app: "+a.split(" ")[0]+"</i>");handleCommand(a,j,0,function(){l("Chatting not allowed until your logged in!")});$("#chatinput").e("").focus();return!1})});
function l(a){var b=$("#chatlog"),c=$('<div style="color:#'+Math.floor(16777215*Math.random()-2E4).toString(16)+'"/>');c.c(a);$(c).g("slow");b.j(c)}var n;
if(this.matchMedia)n=h;else{var p,q=document,r=q.documentElement,s=r.firstElementChild||r.firstChild,t=!q.body,u=q.body||q.createElement("body"),v=q.createElement("div");v.id="mq-test-1";v.style.cssText="position:absolute;top:-99em";u.appendChild(v);v.innerHTML='_<style media="only all"> #mq-test-1 { width: 9px; }</style>';t&&r.insertBefore(u,s);v.removeChild(v.firstChild);p=9==v.offsetWidth;t?r.removeChild(u):u.removeChild(v);n=p}var x=this,y=n;function z(){A(h)}x.l={};respond.update=function(){};
respond.h=y;
if(!y){var B=x.document,E=B.documentElement,F=[],G=[],H=[],I={},J=B.getElementsByTagName("head")[0]||E,K=J.getElementsByTagName("link"),L=[],O=function(){for(var a=K.length,b=0,c,d,e,g;b<a;b++)c=K[b],d=c.href,e=c.media,g=c.rel&&"stylesheet"===c.rel.toLowerCase(),d&&g&&!I[d]&&(c.styleSheet&&c.styleSheet.d?(M(c.styleSheet.d,d,e),I[d]=h):(!/^([a-zA-Z]+?:(\/\/)?)/.test(d)||d.replace(RegExp.$1,"").split("/")[0]===x.location.host)&&L.push({href:d,media:e}));N()},N=function(){if(L.length){var a=L.shift(),
b=a.href,c=P();c&&(c.open("GET",b,h),c.onreadystatechange=function(){4!=c.readyState||200!=c.status&&304!=c.status||(M(c.responseText,a.href,a.media),I[a.href]=h,N())},4!=c.readyState&&c.send(null))}},M=function(a,b,c){function d(a){return a.replace(/(url\()['"]?([^\/\)'"][^:\)'"]+)['"]?(\))/g,"$1"+b+"$2$3")}var e=a.match(/@media[^\{]+\{([^\{\}]+\{[^\}\{]+\})+/gi),g=e&&e.length||0,b=b.substring(0,b.lastIndexOf("/")),f=!g&&c,m=0,w,C,D,Q;b.length&&(b+="/");for(f&&(g=1);m<g;m++){w=0;f?(C=c,G.push(d(a))):
(C=e[m].match(/@media ([^\{]+)\{([\S\s]+?)$/)&&RegExp.$1,G.push(RegExp.$2&&d(RegExp.$2)));D=C.split(",");for(Q=D.length;w<Q;w++)C=D[w],F.push({media:C.match(/(only\s+)?([a-zA-Z]+)(\sand)?/)&&RegExp.$2,rules:G.length-1,b:C.match(/\(min\-width:[\s]*([\s]*[0-9]+)px[\s]*\)/)&&parseFloat(RegExp.$1),a:C.match(/\(max\-width:[\s]*([\s]*[0-9]+)px[\s]*\)/)&&parseFloat(RegExp.$1)})}A()},R,S,A=function(a){var b=E.clientWidth,c="CSS1Compat"===B.compatMode&&b||B.body.clientWidth||b,b={},d=B.createDocumentFragment(),
e=K[K.length-1],g=(new Date).getTime();if(a&&R&&30>g-R)clearTimeout(S),S=setTimeout(A,30);else{R=g;for(var f in F)if(a=F[f],!a.b&&!a.a||(!a.b||a.b&&c>=a.b)&&(!a.a||a.a&&c<=a.a))b[a.media]||(b[a.media]=[]),b[a.media].push(G[a.rules]);for(f in H)H[f]&&H[f].parentNode===J&&J.removeChild(H[f]);for(f in b)a=B.createElement("style"),c=b[f].join("\n"),a.type="text/css",a.media=f,a.styleSheet?a.styleSheet.cssText=c:a.appendChild(B.createTextNode(c)),d.appendChild(a),H.push(a);J.insertBefore(d,e.nextSibling)}},
P,T=!1;try{T=new XMLHttpRequest}catch(U){T=new ActiveXObject("Microsoft.XMLHTTP")}P=function(){return T};O();respond.update=O;x.addEventListener?x.addEventListener("resize",z,!1):x.attachEvent&&x.attachEvent("onresize",z)};var conn=null;function connect(){!1!=isAuth()&&(disconnect(),flog_navStart("socket"),conn=new SockJS("http://"+window.location.hostname+":8080/chat","websocket xhr-streaming xhr-polling jsonp-polling xdr-streaming xdr-polling iframe-eventsource iframe-htmlfile".split(" ")),conn.onopen=function(){update_ui()},conn.onmessage=function(a){handleCommand(a.data,msgToApp,0,delayed_stream)},conn.onclose=function(){log("Disconnected.");auth_logout();conn=null;update_ui()})}
function disconnect(){null!=conn&&(log("Disconnecting..."),conn.close(),conn=null,update_ui())}function isConnected(){return null!=conn&&conn.readyState==SockJS.OPEN}function update_ui(){!1==isConnected()?$("#status").text("disconnected"):$("#status").text("connected ("+conn.protocol+")")}
$(function(){$("#reset").click(function(){$("#chatlog").html("")});$("#chatform").submit(function(){var a=$("#chatinput").val(),a=a.replace(/<(?:.|\n)*?>/gm,"");if(!0==isSysMsg(a))return!1;if(!0==isAppMsg(a)){var b=a.split(" ");log("<i>sent to app: "+b[0]+"</i>")}isConnected()?conn.send(getName()+": "+a):handleCommand(a,msgToApp,0,function(){log("Chatting not allowed until your logged in!")});$("#chatinput").val("").focus();return!1})});function log(a){var b=$("#chatlog"),c="#"+Math.floor(16777215*Math.random()-2E4).toString(16),c=$('<div style="color:'+c+'"/>');c.html(a);$(c).fadeIn("slow");b.prepend(c);return c}function delayed_stream(a,b){var c=log(""),d=a.split(""),e=function(a){if(0==d.length)cb(b);else{var f=d.shift();c.append(f);var m=25+0.42*f.charCodeAt(0)+25*Math.random();if("."==a||"!"==a||"?"==a)m+=200;setTimeout(function(){e(f)},m)}};e()}
function delayed_convo(a,b){var c=function(){if(0==a.length)cb(b);else{var d=a.shift();setTimeout(function(){delayed_stream(d,c)},800)}};c()};(function(a,b){function c(){Z(!0)}a.respond={};respond.update=function(){};respond.mediaQueriesSupported=b;if(!b){var d=a.document,e=d.documentElement,g=[],f=[],m=[],w={},C=d.getElementsByTagName("head")[0]||e,D=C.getElementsByTagName("link"),Q=[],aa=function(){for(var c=D.length,b=0,d,e,f,g;b<c;b++)d=D[b],e=d.href,f=d.media,g=d.rel&&"stylesheet"===d.rel.toLowerCase(),e&&(g&&!w[e])&&(d.styleSheet&&d.styleSheet.rawCssText?(ba(d.styleSheet.rawCssText,e,f),w[e]=!0):(!/^([a-zA-Z]+?:(\/\/)?)/.test(e)||
e.replace(RegExp.$1,"").split("/")[0]===a.location.host)&&Q.push({href:e,media:f}));ca()},ca=function(){if(Q.length){var a=Q.shift();var c=a.href,b=da();b&&(b.open("GET",c,!0),b.onreadystatechange=function(){4!=b.readyState||200!=b.status&&304!=b.status||(ba(b.responseText,a.href,a.media),w[a.href]=!0,ca())},4!=b.readyState&&b.send(null))}},ba=function(a,b,c){var d=a.match(/@media[^\{]+\{([^\{\}]+\{[^\}\{]+\})+/gi),e=d&&d.length||0,b=b.substring(0,b.lastIndexOf("/")),m=function(a){return a.replace(/(url\()['"]?([^\/\)'"][^:\)'"]+)['"]?(\))/g,
"$1"+b+"$2$3")},C=!e&&c,w=0,D,W,Q,X;b.length&&(b+="/");for(C&&(e=1);w<e;w++){D=0;C?(W=c,f.push(m(a))):(W=d[w].match(/@media ([^\{]+)\{([\S\s]+?)$/)&&RegExp.$1,f.push(RegExp.$2&&m(RegExp.$2)));Q=W.split(",");for(X=Q.length;D<X;D++)W=Q[D],g.push({media:W.match(/(only\s+)?([a-zA-Z]+)(\sand)?/)&&RegExp.$2,rules:f.length-1,minw:W.match(/\(min\-width:[\s]*([\s]*[0-9]+)px[\s]*\)/)&&parseFloat(RegExp.$1),maxw:W.match(/\(max\-width:[\s]*([\s]*[0-9]+)px[\s]*\)/)&&parseFloat(RegExp.$1)})}Z()},X,ea,Z=function(a){var b=
e.clientWidth,c="CSS1Compat"===d.compatMode&&b||d.body.clientWidth||b,b={},w=d.createDocumentFragment(),Q=D[D.length-1],Y=(new Date).getTime();if(a&&X&&30>Y-X)clearTimeout(ea),ea=setTimeout(Z,30);else{X=Y;for(var V in g)if(a=g[V],!a.minw&&!a.maxw||(!a.minw||a.minw&&c>=a.minw)&&(!a.maxw||a.maxw&&c<=a.maxw))b[a.media]||(b[a.media]=[]),b[a.media].push(f[a.rules]);for(V in m)m[V]&&m[V].parentNode===C&&C.removeChild(m[V]);for(V in b)a=d.createElement("style"),c=b[V].join("\n"),a.type="text/css",a.media=
V,a.styleSheet?a.styleSheet.cssText=c:a.appendChild(d.createTextNode(c)),w.appendChild(a),m.push(a);C.insertBefore(w,Q.nextSibling)}},da,Y=!1;try{Y=new XMLHttpRequest}catch(fa){Y=new ActiveXObject("Microsoft.XMLHTTP")}da=function(){return Y};aa();respond.update=aa;a.addEventListener?a.addEventListener("resize",c,!1):a.attachEvent&&a.attachEvent("onresize",c)}})(this,function(a){if(a.matchMedia)return!0;var b,c=document,a=c.documentElement;b=a.firstElementChild||a.firstChild;var d=!c.body,e=c.body||
c.createElement("body"),c=c.createElement("div");c.id="mq-test-1";c.style.cssText="position:absolute;top:-99em";e.appendChild(c);c.innerHTML='_<style media="only all"> #mq-test-1 { width: 9px; }</style>';d&&a.insertBefore(e,b);c.removeChild(c.firstChild);b=9==c.offsetWidth;d?a.removeChild(e):e.removeChild(c);return b}(this));window.onLoad=onLoad;function onLoad(){flog_navStart("html");isAuth()?authed():notAuthed();update_ui()}function authed(){connect();addApp("http://jadders.dyndns.org:81/apps/appvote.html")}function notAuthed(){$(".authed").remove();addApp("http://jadders.dyndns.org:81/apps/appauth.html");$.getJSON("static/auth/authchat.json",function(a){delayed_convo(a)})}function flog(a){var b=$("#footer");b.html(b.html()+a)}
function flog_navStart(a){if(!(void 0==window.performance||void 0==performance.timing||void 0==performance.timing.navigationStart)){var b=(new Date).getTime()-performance.timing.navigationStart;flog(" "+a+":"+b/1E3)}};function handleCoreCommand(a,b){0==a.indexOf("resize")&&resizeIFrameMsg(a,b);if(0==a.indexOf("reload")&&!1==isAuth()){var c=a.split(" ");auth_onLogin(c[1],c[2])}}function resizeIFrameMsg(a,b){var c=parseInt(a.replace("resize ",""));$(b).height(c)};
